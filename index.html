<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced SFS Pricing Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            z-index: 10;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .analytics-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .analytics-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .main-content {
            padding: 30px;
            position: relative;
            z-index: 1;
        }

        .connection-status {
            background: #d4edda;
            color: #155724;
            padding: 10px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            text-align: center;
            font-weight: 500;
        }

        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-container {
            flex: 1;
            position: relative;
            max-width: 500px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 1.2rem;
        }

        .items-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .table-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            display: grid;
            grid-template-columns: 90px 180px 120px 100px 80px 100px 90px 90px 90px 90px 80px 80px;
            gap: 15px;
            font-weight: 600;
            color: #334155;
            font-size: 0.9rem;
        }

        .table-row {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: grid;
            grid-template-columns: 90px 180px 120px 100px 80px 100px 90px 90px 90px 90px 80px 80px;
            gap: 15px;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .table-row:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .sku {
            font-weight: 600;
            color: #1e40af;
            font-size: 0.9rem;
        }

        .description {
            color: #334155;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .brand {
            color: #6b7280;
            font-size: 0.85rem;
        }

        .customer {
            color: #059669;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .price {
            font-weight: 700;
            color: #dc2626;
            font-size: 0.9rem;
            text-align: right;
        }

        .margin {
            font-weight: 600;
            text-align: center;
            font-size: 0.85rem;
        }

        .margin-good { color: #059669; }
        .margin-warning { color: #d97706; }
        .margin-danger { color: #dc2626; }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* MODAL STYLES */
        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .detail-content {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .detail-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 25px 30px;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .item-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .item-subtitle {
            opacity: 0.9;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .detail-body {
            padding: 30px;
        }

        .price-flow {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
        }

        .price-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
        }

        .price-card.exw { border-color: #64748b; }
        .price-card.fob { border-color: #3b82f6; }
        .price-card.ddp { border-color: #10b981; }

        .price-label {
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .price-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1e40af;
        }

        .arrow {
            font-size: 1.5rem;
            color: #64748b;
            font-weight: bold;
        }

        .perspectives {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .perspective {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e2e8f0;
        }

        .perspective.vendor {
            background: linear-gradient(135deg, #fef3c7 0%, #fef7cd 100%);
            border-color: #f59e0b;
        }

        .perspective.shipping {
            background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%);
            border-color: #3b82f6;
        }

        .perspective.margins {
            background: linear-gradient(135deg, #d1fae5 0%, #dcfce7 100%);
            border-color: #10b981;
        }

        .perspective h3 {
            color: #1e40af;
            margin-bottom: 20px;
            font-size: 1.1rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cost-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .cost-line:last-child {
            border-bottom: none;
        }

        .cost-line.total {
            font-weight: 700;
            color: #059669;
            font-size: 1rem;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #10b981;
        }

        .cost-label {
            color: #4b5563;
        }

        .cost-value {
            font-weight: 600;
            color: #1f2937;
        }

        .container-section {
            background: linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #a855f7;
        }

        .container-section h3 {
            color: #7c3aed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .container-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .container-stat {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid #d8b4fe;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #7c3aed;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .customer-section {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #10b981;
        }

        .customer-section h3 {
            color: #059669;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .customer-info {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #a7f3d0;
        }

        .customer-name {
            font-weight: 700;
            color: #059669;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .contact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .contact-icon {
            width: 16px;
            text-align: center;
        }

        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .retry-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
        }

        .retry-button:hover {
            background: #2563eb;
        }

        .sample-data-button {
            background: #059669;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
        }

        .sample-data-button:hover {
            background: #047857;
        }

        @media (max-width: 1400px) {
            .table-header,
            .table-row {
                grid-template-columns: 80px 150px 100px 90px 70px 90px 80px 80px 80px 80px 70px 70px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 1200px) {
            .perspectives {
                grid-template-columns: 1fr;
            }
            
            .price-flow {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .arrow {
                transform: rotate(90deg);
            }
        }

        @media (max-width: 768px) {
            .table-header,
            .table-row {
                grid-template-columns: 1fr;
                gap: 5px;
                font-size: 0.8rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏠 Enhanced SFS Pricing Portal</h1>
            <p>Victory Foods & Customer Pricing Portal - Complete Supply Chain Analysis</p>
        </div>

        <div class="main-content">
            <div id="connectionStatus" class="connection-status">
                Initializing enhanced database connection...
            </div>

            <div class="controls">
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search items, SKU, customer, brand, or category...">
                    <div class="search-icon">🔍</div>
                </div>
                <div id="filtersContainer" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
            </div>

            <div id="debugInfo" class="debug-info" style="display: none;">
                <strong>Debug Information:</strong><br>
                <div id="debugContent"></div>
            </div>

            <div class="items-table" id="itemsTable">
                <div class="table-header">
                    <div>SKU</div>
                    <div>Description</div>
                    <div>Brand/Category</div>
                    <div>Customer</div>
                    <div>Quarter</div>
                    <div>Package</div>
                    <div>EXW Cost</div>
                    <div>FOB Price</div>
                    <div>DDP Price</div>
                    <div>Net Price</div>
                    <div>SFS Margin</div>
                    <div>Actions</div>
                </div>
                
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                    <div>Loading enhanced Victory Foods pricing data...</div>
                    <div style="margin-top: 20px;">
                        <button class="retry-button" onclick="retryConnection()">🔄 Retry Connection</button>
                        <button class="sample-data-button" onclick="loadSampleData()">📊 Load Sample Data</button>
                        <button class="retry-button" onclick="toggleDebug()">🐛 Show Debug Info</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Default Detail Modal -->
    <div class="detail-modal" id="detailModal">
        <div class="detail-content">
            <div class="detail-header">
                <button class="close-btn" onclick="closeDetail()">&times;</button>
                <div class="item-title" id="detailItemTitle">Loading...</div>
                <div class="item-subtitle" id="detailItemSubtitle">Loading details...</div>
            </div>
            
            <div class="detail-body">
                <!-- Price Flow Overview -->
                <div class="price-flow">
                    <div class="price-card exw">
                        <div class="price-label">EXW Factory Cost</div>
                        <div class="price-value" id="exwPrice">$15.80</div>
                        <div style="font-size: 0.75rem; color: #64748b; margin-top: 4px;" id="exwPerUnit">
                            $3.95/unit
                        </div>
                    </div>
                    <div class="arrow">→</div>
                    <div class="price-card fob">
                        <div class="price-label">FOB Price</div>
                        <div class="price-value" id="fobPrice">$23.38</div>
                        <div style="font-size: 0.75rem; color: #64748b; margin-top: 4px;" id="fobMarkup">
                            +$7.58 markup
                        </div>
                    </div>
                    <div class="arrow">→</div>
                    <div class="price-card ddp">
                        <div class="price-label">DDP Price</div>
                        <div class="price-value" id="ddpPrice">$23.89</div>
                        <div style="font-size: 0.75rem; color: #64748b; margin-top: 4px;" id="ddpFreight">
                            +$0.51 freight
                        </div>
                    </div>
                    <div class="arrow">→</div>
                    <div class="price-card" style="border-color: #10b981;">
                        <div class="price-label">Net Price</div>
                        <div class="price-value" style="color: #059669;" id="netPrice">$1.01</div>
                        <div style="font-size: 0.75rem; color: #059669; margin-top: 4px;" id="rebateInfo">
                            -$22.88 rebate
                        </div>
                    </div>
                </div>

                <!-- Container & Logistics Overview -->
                <div class="container-section">
                    <h3>🚢 Container & Logistics Information</h3>
                    <div class="container-grid">
                        <div class="container-stat">
                            <div class="stat-value" id="containerCases">2,200</div>
                            <div class="stat-label">Cases per Container</div>
                        </div>
                        <div class="container-stat">
                            <div class="stat-value" id="containerWeight">52,800 lbs</div>
                            <div class="stat-label">Net Weight</div>
                        </div>
                        <div class="container-stat">
                            <div class="stat-value" id="oceanFreightTotal">$5,675</div>
                            <div class="stat-label">Ocean Freight Total</div>
                        </div>
                        <div class="container-stat">
                            <div class="stat-value" id="inlandFreightTotal">$1,122</div>
                            <div class="stat-label">Inland Freight Total</div>
                        </div>
                        <div class="container-stat">
                            <div class="stat-value" id="oceanFreightPerCase">$2.58</div>
                            <div class="stat-label">Ocean Freight/Case</div>
                        </div>
                        <div class="container-stat">
                            <div class="stat-value" id="inlandFreightPerCase">$0.51</div>
                            <div class="stat-label">Inland Freight/Case</div>
                        </div>
                        <div class="container-stat">
                            <div class="stat-value" id="palletPattern">10×11</div>
                            <div class="stat-label">Pallet Pattern (TI×HI)</div>
                        </div>
                        <div class="container-stat">
                            <div class="stat-value" id="configuration">Palletized</div>
                            <div class="stat-label">Configuration</div>
                        </div>
                        <div class="container-stat">
                            <div class="stat-value" id="deliveryLocation">Bronx, NY</div>
                            <div class="stat-label">Delivery Location</div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Cost Perspectives -->
                <div class="perspectives">
                    <div class="perspective vendor">
                        <h3>📦 Vendor & Import Costs</h3>
                        <div id="vendorCosts">
                            <div class="cost-line">
                                <span class="cost-label">EXW Factory Cost:</span>
                                <span class="cost-value">$15.80</span>
                            </div>
                            <div class="cost-line">
                                <span class="cost-label">Sales Broker (3.0%):</span>
                                <span class="cost-value">$0.72</span>
                            </div>
                            <div class="cost-line">
                                <span class="cost-label">Tariff (10.0%):</span>
                                <span class="cost-value">$1.58</span>
                            </div>
                            <div class="cost-line">
                                <span class="cost-label">Import Broker:</span>
                                <span class="cost-value">$0.14</span>
                            </div>
                            <div class="cost-line total">
                                <span class="cost-label">Total Landed Cost:</span>
                                <span class="cost-value">$18.24</span>
                            </div>
                        </div>
                    </div>

                    <div class="perspective shipping">
                        <h3>🚢 Shipping & Logistics</h3>
                        <div id="shippingCosts">
                            <div class="cost-line">
                                <span class="cost-label">FOB to DDP Freight:</span>
                                <span class="cost-value">$0.51</span>
                            </div>
                            <div class="cost-line">
                                <span class="cost-label">Ocean Freight/Case:</span>
                                <span class="cost-value">$2.58</span>
                            </div>
                            <div class="cost-line">
                                <span class="cost-label">Inland Freight/Case:</span>
                                <span class="cost-value">$0.51</span>
                            </div>
                            <div class="cost-line">
                                <span class="cost-label">Case Weight:</span>
                                <span class="cost-value">24 lbs</span>
                            </div>
                            <div class="cost-line">
                                <span class="cost-label">Units per Case:</span>
                                <span class="cost-value">4 units</span>
                            </div>
                            <div class="cost-line total">
                                <span class="cost-label">Cost per Unit:</span>
                                <span class="cost-value">$5.97</span>
                            </div>
                        </div>
                    </div>

                    <div class="perspective margins">
                        <h3>💰 SFS Margins & Profitability</h3>
                        <div id="sfsMargins">
                            <div class="cost-line">
                                <span class="cost-label">Total Cost (Landed + Freight):</span>
                                <span class="cost-value">$18.75</span>
                            </div>
                            <div class="cost-line">
                                <span class="cost-label">SFS Margin (16.2%):</span>
                                <span class="cost-value">$2.56</span>
                            </div>
                            <div class="cost-line">
                                <span class="cost-label">Gross Margin:</span>
                                <span class="cost-value">$5.14</span>
                            </div>
                            <div class="cost-line">
                                <span class="cost-label">DDP List Price:</span>
                                <span class="cost-value">$23.89</span>
                            </div>
                            <div class="cost-line" style="color: #059669;">
                                <span class="cost-label">Customer Rebate:</span>
                                <span class="cost-value">-$22.88</span>
                            </div>
                            <div class="cost-line total" style="color: #059669;">
                                <span class="cost-label">Net Customer Price:</span>
                                <span class="cost-value">$1.01</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Information -->
                <div class="customer-section">
                    <h3>🏢 Customer Information & Contact Details</h3>
                    <div class="customer-info" id="customerDetails">
                        <div class="customer-name">Victory Foods</div>
                        <div class="contact-grid">
                            <div class="contact-item">
                                <span class="contact-icon">👤</span>
                                <span>Alan Bernstein</span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon">📞</span>
                                <span>718-378-1122</span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon">📧</span>
                                <span>abernstein@victoryfoodservice.com</span>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon">📍</span>
                                <span>515 Truxton St. Bronx, NY 10474</span>
                            </div>
                        </div>
                        <div class="cost-line">
                            <span class="cost-label">Rebate per Case:</span>
                            <span class="cost-value">$22.88</span>
                        </div>
                        <div class="cost-line">
                            <span class="cost-label">Net Price per Case:</span>
                            <span class="cost-value">$1.01</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Database configuration  
        const SUPABASE_URL = 'https://knrzvhxavdyvrbbcgkqf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtucnp2aHhhdmR5dnJiYmNna3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyNDQzNjgsImV4cCI6MjA2NzgyMDM2OH0.DUuvdCeHSEnbBobnRWQ1rCNLKePwXGkia3Ewt40WnmQ';
        
        let currentItems = [];
        let allItemsData = [];
        let debugLog = [];

        // Enhanced logging function
        function logDebug(message, data = null) {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            if (data) {
                debugLog.push(JSON.stringify(data, null, 2));
            }
            console.log(logEntry, data);
            updateDebugDisplay();
        }

        function updateDebugDisplay() {
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                debugContent.innerHTML = debugLog.slice(-20).join('<br>');
            }
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        // Enhanced database fetch function with better error handling
        async function fetchFromDatabase(endpoint, options = {}) {
            try {
                logDebug(`Attempting to fetch: ${endpoint}`);
                
                const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
                const headers = {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                };

                logDebug(`Making request to: ${url}`);
                
                const response = await fetch(url, {
                    headers,
                    ...options
                });
                
                logDebug(`Response status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    logDebug(`Successfully fetched data`, { recordCount: data.length, sample: data[0] });
                    return data;
                } else {
                    const errorText = await response.text();
                    logDebug(`API Error: ${response.status}`, errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                logDebug(`Fetch error: ${error.message}`, error);
                throw error;
            }
        }

        // Update connection status
        function updateConnectionStatus(message, type = 'success') {
            const status = document.getElementById('connectionStatus');
            status.textContent = message;
            status.className = `connection-status ${type === 'success' ? '' : type}`;
            logDebug(`Status update: ${message} (${type})`);
        }

        // Test basic connectivity
        async function testBasicConnectivity() {
            try {
                updateConnectionStatus('Testing basic connectivity...', 'warning');
                
                // Try a simple query first
                const testData = await fetchFromDatabase('items?select=count');
                logDebug('Basic connectivity test passed', testData);
                return true;
            } catch (error) {
                logDebug('Basic connectivity test failed', error);
                return false;
            }
        }

        // Database analysis function to check what's available - UPDATED FOR REAL SCHEMA
        async function analyzeDatabaseStructure() {
            logDebug('Starting comprehensive database analysis...');
            updateConnectionStatus('🔍 Analyzing MPC database structure...', 'warning');
            
            const tables = [
                'items',
                'customers', 
                'vendors',
                'pricing_breakdown',
                'customer_price_history',
                'vendor_price_history',
                'price_quarters',
                'container_logistics',
                'info_sheet_processing_log'
            ];

            const analysis = {};

            for (const table of tables) {
                try {
                    logDebug(`Checking ${table} table...`);
                    
                    // Get table structure and sample data
                    const data = await fetchFromDatabase(`${table}?select=*&limit=3`);
                    
                    if (data && Array.isArray(data)) {
                        analysis[table] = {
                            recordCount: data.length,
                            sampleData: data[0] || null,
                            allFields: data[0] ? Object.keys(data[0]) : [],
                            available: true
                        };
                        
                        logDebug(`✅ ${table}: Found ${data.length} records with fields: ${data[0] ? Object.keys(data[0]).join(', ') : 'none'}`);
                        
                        // Log sample data for key tables
                        if (data[0] && ['items', 'customers', 'vendors', 'pricing_breakdown'].includes(table)) {
                            logDebug(`${table} sample:`, data[0]);
                        }
                    } else {
                        analysis[table] = { available: false, error: 'No data or invalid response' };
                        logDebug(`❌ ${table}: No data or invalid response`);
                    }
                } catch (error) {
                    analysis[table] = { available: false, error: error.message };
                    logDebug(`❌ ${table}: Error - ${error.message}`);
                }
            }

            // Log comprehensive analysis
            logDebug('=== MPC DATABASE ANALYSIS COMPLETE ===');
            for (const [table, info] of Object.entries(analysis)) {
                if (info.available) {
                    logDebug(`✅ ${table}: ${info.recordCount} records, Fields: ${info.allFields.join(', ')}`);
                } else {
                    logDebug(`❌ ${table}: ${info.error}`);
                }
            }

            return analysis;
        }

        // Enhanced data loading optimized for your schema
        async function loadRealDatabaseItems() {
            try {
                updateConnectionStatus('🔍 Loading from MPC database tables...', 'warning');
                
                // First, analyze what's available in the database
                const dbAnalysis = await analyzeDatabaseStructure();
                
                // Strategy 1: Try comprehensive join with all related tables
                if (dbAnalysis.pricing_breakdown?.available && dbAnalysis.items?.available) {
                    try {
                        logDebug('Strategy 1: Loading comprehensive pricing data with joins...');
                        
                        const comprehensiveQuery = `pricing_breakdown?select=*,items(*),customers(*),price_quarters(*),vendor_price_history(vendors(*))`;
                        const comprehensiveData = await fetchFromDatabase(comprehensiveQuery);
                        
                        if (comprehensiveData && comprehensiveData.length > 0) {
                            logDebug('✅ Comprehensive join query successful');
                            updateConnectionStatus(`✅ Loaded ${comprehensiveData.length} items with complete supply chain data`);
                            return processComprehensiveData(comprehensiveData);
                        }
                    } catch (error) {
                        logDebug('Comprehensive join failed, trying simpler joins...', error);
                    }
                }

                // Strategy 2: Load main pricing data with basic joins
                if (dbAnalysis.pricing_breakdown?.available) {
                    try {
                        logDebug('Strategy 2: Loading pricing breakdown with basic joins...');
                        
                        const pricingQuery = `pricing_breakdown?select=*,items(*),customers(*),price_quarters(*)`;
                        const pricingData = await fetchFromDatabase(pricingQuery);
                        
                        if (pricingData && pricingData.length > 0) {
                            logDebug('✅ Basic pricing join successful');
                            updateConnectionStatus(`✅ Loaded ${pricingData.length} pricing records from MPC database`);
                            return processBasicPricingData(pricingData, dbAnalysis);
                        }
                    } catch (error) {
                        logDebug('Basic pricing join failed, trying individual tables...', error);
                    }
                }

                // Strategy 3: Load individual tables and join manually
                const loadPromises = [];
                const availableTables = {};
                
                if (dbAnalysis.pricing_breakdown?.available) {
                    loadPromises.push(fetchFromDatabase('pricing_breakdown?select=*').then(data => {
                        availableTables.pricing = data;
                        return data;
                    }));
                }
                
                if (dbAnalysis.items?.available) {
                    loadPromises.push(fetchFromDatabase('items?select=*').then(data => {
                        availableTables.items = data;
                        return data;
                    }));
                }
                
                if (dbAnalysis.customers?.available) {
                    loadPromises.push(fetchFromDatabase('customers?select=*').then(data => {
                        availableTables.customers = data;
                        return data;
                    }));
                }
                
                if (dbAnalysis.vendors?.available) {
                    loadPromises.push(fetchFromDatabase('vendors?select=*').then(data => {
                        availableTables.vendors = data;
                        return data;
                    }));
                }
                
                if (dbAnalysis.price_quarters?.available) {
                    loadPromises.push(fetchFromDatabase('price_quarters?select=*').then(data => {
                        availableTables.quarters = data;
                        return data;
                    }));
                }

                if (dbAnalysis.container_logistics?.available) {
                    loadPromises.push(fetchFromDatabase('container_logistics?select=*').then(data => {
                        availableTables.logistics = data;
                        return data;
                    }));
                }

                await Promise.allSettled(loadPromises);
                
                logDebug('Available tables loaded:', Object.keys(availableTables));

                // Process available data
                if (availableTables.pricing && availableTables.pricing.length > 0) {
                    updateConnectionStatus(`✅ Loaded real data from ${Object.keys(availableTables).length} MPC database tables`);
                    return processIndividualTables(availableTables);
                }

                // Strategy 4: Check if any individual tables have data we can use
                if (availableTables.items && availableTables.items.length > 0) {
                    logDebug('Creating data from items table...');
                    updateConnectionStatus(`✅ Loaded ${availableTables.items.length} items from MPC database`);
                    return createDataFromItems(availableTables.items, availableTables.customers, availableTables.vendors);
                }

                // Fallback to sample data
                logDebug('No usable data found, using sample data');
                updateConnectionStatus('📊 MPC database connected but no pricing data found. Using sample data.', 'warning');
                return createSampleData();

            } catch (error) {
                logDebug('Complete database loading failed', error);
                updateConnectionStatus('❌ MPC database error. Using sample data.', 'error');
                return createSampleData();
            }
        }

        // Process comprehensive data with all joins
        function processComprehensiveData(data) {
            return data.map(record => ({
                id: record.id,
                sku: record.items?.sku || 'N/A',
                description: record.items?.description || 'N/A',
                brand: record.items?.brand || 'N/A',
                category: record.items?.category || 'N/A',
                customer: record.customers?.name || 'N/A',
                customer_code: record.customers?.code || 'N/A',
                package: record.items?.package_format || record.items?.package_size || 'N/A',
                units_per_case: record.items?.units_per_case || 1,
                case_weight: record.items?.case_weight_lbs || record.items?.weight_per_unit || 0,
                
                exw_cost: record.exw_cost_case || 0,
                fob_price: record.fob_price_case || 0,
                ddp_price: record.ddp_price_case || 0,
                ddp_net_price: record.ddp_net_price_case || 0,
                ddp_rebate: record.ddp_rebate_case || 0,
                
                sfs_margin_rate: record.sfs_margin_rate_percent || 0,
                quarter: record.price_quarters?.quarter_name || 'N/A',
                
                rawData: {
                    ...record,
                    vendor: record.vendor_price_history?.[0]?.vendors || null,
                    logistics: null // Will be populated separately if needed
                }
            }));
        }

        // Process basic pricing data
        function processBasicPricingData(data, dbAnalysis) {
            return data.map(record => ({
                id: record.id,
                sku: record.items?.sku || 'N/A',
                description: record.items?.description || 'N/A',
                brand: record.items?.brand || 'N/A',
                category: record.items?.category || 'N/A',
                customer: record.customers?.name || 'N/A',
                customer_code: record.customers?.code || 'N/A',
                package: record.items?.package_format || record.items?.package_size || 'N/A',
                units_per_case: record.items?.units_per_case || 1,
                case_weight: record.items?.case_weight_lbs || record.items?.weight_per_unit || 0,
                
                exw_cost: record.exw_cost_case || 0,
                fob_price: record.fob_price_case || 0,
                ddp_price: record.ddp_price_case || 0,
                ddp_net_price: record.ddp_net_price_case || 0,
                ddp_rebate: record.ddp_rebate_case || 0,
                
                sfs_margin_rate: record.sfs_margin_rate_percent || 0,
                quarter: record.price_quarters?.quarter_name || 'N/A',
                
                rawData: record
            }));
        }

        // Process individual tables with improved mapping
        function processIndividualTables(tables) {
            const { pricing, items, customers, quarters, vendors, logistics } = tables;
            
            logDebug(`Processing MPC data: ${pricing?.length || 0} pricing, ${items?.length || 0} items, ${customers?.length || 0} customers, ${quarters?.length || 0} quarters, ${vendors?.length || 0} vendors`);
            
            return (pricing || []).map(record => {
                const item = (items || []).find(i => i.id === record.item_id) || {};
                const customer = (customers || []).find(c => c.id === record.customer_id) || {};
                const quarter = (quarters || []).find(q => q.id === record.quarter_id) || {};
                const customerLogistics = (logistics || []).find(l => l.customer_id === record.customer_id && l.quarter_id === record.quarter_id) || {};
                
                return {
                    id: record.id,
                    sku: item.sku || record.sku || 'N/A',
                    description: item.description || record.description || 'N/A',
                    brand: item.brand || record.brand || 'N/A',
                    category: item.category || record.category || 'N/A',
                    customer: customer.name || record.customer_name || 'N/A',
                    customer_code: customer.code || record.customer_code || 'N/A',
                    package: item.package_format || item.package_size || record.package_format || 'N/A',
                    units_per_case: item.units_per_case || record.units_per_case || 1,
                    case_weight: item.case_weight_lbs || item.weight_per_unit || record.case_weight_lbs || 0,
                    
                    exw_cost: record.exw_cost_case || 0,
                    fob_price: record.fob_price_case || 0,
                    ddp_price: record.ddp_price_case || 0,
                    ddp_net_price: record.ddp_net_price_case || 0,
                    ddp_rebate: record.ddp_rebate_case || 0,
                    
                    sfs_margin_rate: record.sfs_margin_rate_percent || 0,
                    quarter: quarter.quarter_name || record.quarter || 'N/A',
                    
                    rawData: {
                        ...record,
                        customer_info: customer,
                        item_info: item,
                        quarter_info: quarter,
                        logistics_info: customerLogistics
                    }
                };
            });
        }

        // Create data from items table when pricing data isn't available
        function createDataFromItems(items, customers, vendors) {
            return items.map((item, index) => {
                const customer = customers && customers.length > 0 ? customers[index % customers.length] : null;
                const vendor = vendors ? vendors.find(v => v.sku === item.sku || v.item_id === item.id) : null;
                
                return {
                    id: item.id,
                    sku: item.sku || 'N/A',
                    description: item.description || 'N/A',
                    brand: item.brand || 'N/A',
                    category: item.category || 'N/A',
                    customer: customer?.name || 'Unknown Customer',
                    customer_code: customer?.code || 'UNK',
                    package: item.package_format || 'N/A',
                    units_per_case: item.units_per_case || 1,
                    case_weight: item.case_weight_lbs || 0,
                    
                    exw_cost: vendor?.exw_price_case || item.base_cost || 0,
                    fob_price: vendor?.fob_price_case || item.fob_price || 0,
                    ddp_price: vendor?.ddp_price_case || item.ddp_price || 0,
                    ddp_net_price: item.net_price || 0,
                    ddp_rebate: item.rebate_amount || 0,
                    
                    sfs_margin_rate: item.margin_rate || 0,
                    quarter: 'Q2 2025',
                    
                    rawData: {
                        ...item,
                        vendor: vendor
                    }
                };
            });
        }

        // Process complex join data
        function processComplexData(data) {
            updateConnectionStatus(`✅ Loaded ${data.length} items with complete supply chain data`);
            
            return data.map(record => ({
                id: record.id,
                sku: record.items?.sku || 'N/A',
                description: record.items?.description || 'N/A',
                brand: record.items?.brand || 'N/A',
                category: record.items?.category || 'N/A',
                customer: record.customers?.name || 'N/A',
                customer_code: record.customers?.code || 'N/A',
                package: record.items?.package_format || 'N/A',
                units_per_case: record.items?.units_per_case || 1,
                case_weight: record.items?.case_weight_lbs || 0,
                
                exw_cost: record.exw_cost_case || 0,
                fob_price: record.fob_price_case || 0,
                ddp_price: record.ddp_price_case || 0,
                ddp_net_price: record.ddp_net_price_case || 0,
                ddp_rebate: record.ddp_rebate_case || 0,
                
                sfs_margin_rate: record.sfs_margin_rate_percent || 0,
                quarter: record.price_quarters?.quarter_name || 'N/A',
                
                rawData: record
            }));
        }

        // Process individual table data
        function processIndividualData(pricing, items, customers, quarters) {
            updateConnectionStatus(`✅ Loaded ${pricing.length} pricing records from individual tables`);
            
            return pricing.map(record => {
                const item = items.find(i => i.id === record.item_id) || {};
                const customer = customers.find(c => c.id === record.customer_id) || {};
                const quarter = quarters.find(q => q.id === record.quarter_id) || {};
                
                return {
                    id: record.id,
                    sku: item.sku || 'N/A',
                    description: item.description || 'N/A',
                    brand: item.brand || 'N/A',
                    category: item.category || 'N/A',
                    customer: customer.name || 'N/A',
                    customer_code: customer.code || 'N/A',
                    package: item.package_format || 'N/A',
                    units_per_case: item.units_per_case || 1,
                    case_weight: item.case_weight_lbs || 0,
                    
                    exw_cost: record.exw_cost_case || 0,
                    fob_price: record.fob_price_case || 0,
                    ddp_price: record.ddp_price_case || 0,
                    ddp_net_price: record.ddp_net_price_case || 0,
                    ddp_rebate: record.ddp_rebate_case || 0,
                    
                    sfs_margin_rate: record.sfs_margin_rate_percent || 0,
                    quarter: quarter.quarter_name || 'N/A',
                    
                    rawData: record
                };
            });
        }

        // Create sample data for demonstration
        function createSampleData() {
            updateConnectionStatus('📊 Using sample Victory Foods data for demonstration');
            
            return [
                {
                    id: 'sample-1',
                    sku: '440173',
                    description: 'Sweet Plantain Slices',
                    brand: 'Doria Sofia',
                    category: 'Frozen Vegetables',
                    customer: 'Victory Foods',
                    customer_code: 'VICTORYFO',
                    package: '4/36oz',
                    units_per_case: 4,
                    case_weight: 24,
                    
                    exw_cost: 15.80,
                    fob_price: 23.38,
                    ddp_price: 23.89,
                    ddp_net_price: 1.01,
                    ddp_rebate: 22.88,
                    
                    sfs_margin_rate: 16.2,
                    quarter: 'Q2 2025',
                    
                    rawData: {
                        exw_cost_case: 15.80,
                        fob_price_case: 23.38,
                        ddp_price_case: 23.89,
                        ddp_net_price_case: 1.01,
                        ddp_rebate_case: 22.88,
                        sfs_margin_rate_percent: 16.2,
                        tariff_rate_percent: 10,
                        tariff_amount_case: 1.58,
                        sales_broker_rate_percent: 3,
                        sales_broker_amount_case: 0.72,
                        import_broker_per_case: 0.14,
                        gross_margin_percent: 21.5,
                        gross_margin_amount_case: 5.14
                    }
                },
                {
                    id: 'sample-2',
                    sku: '440174',
                    description: 'Bibigo Chicken & Cilantro Mini Wontons',
                    brand: 'Bibigo',
                    category: 'Frozen Asian',
                    customer: 'Victory Foods',
                    customer_code: 'VICTORYFO',
                    package: '10oz x 4',
                    units_per_case: 4,
                    case_weight: 20,
                    
                    exw_cost: 18.50,
                    fob_price: 27.20,
                    ddp_price: 28.15,
                    ddp_net_price: 26.40,
                    ddp_rebate: 1.75,
                    
                    sfs_margin_rate: 18.5,
                    quarter: 'Q2 2025',
                    
                    rawData: {
                        exw_cost_case: 18.50,
                        fob_price_case: 27.20,
                        ddp_price_case: 28.15,
                        ddp_net_price_case: 26.40,
                        ddp_rebate_case: 1.75,
                        sfs_margin_rate_percent: 18.5,
                        tariff_rate_percent: 12,
                        tariff_amount_case: 2.22,
                        sales_broker_rate_percent: 3,
                        sales_broker_amount_case: 0.82,
                        import_broker_per_case: 0.16,
                        gross_margin_percent: 22.8,
                        gross_margin_amount_case: 6.40
                    }
                }
            ];
        }

        // Show item detail modal - WITH CUSTOM 440173 MODAL
        async function showItemDetail(item) {
            // Check if this is the specific SKU 440173 that should show the custom detailed view
            if (item.sku === '440173') {
                showCustomDetailModal(item);
                return;
            }
            
            // Default modal for other items
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('detailItemTitle');
            const subtitle = document.getElementById('detailItemSubtitle');
            
            title.textContent = `${item.sku} - ${item.description}`;
            subtitle.textContent = `${item.brand} | ${item.package} | 4 units per case`;
            
            // Update price flow with real data
            document.getElementById('exwPrice').textContent = `${item.exw_cost.toFixed(2)}`;
            document.getElementById('fobPrice').textContent = `${item.fob_price.toFixed(2)}`;
            document.getElementById('ddpPrice').textContent = `${item.ddp_price.toFixed(2)}`;
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            updateDetailSections(item.rawData);
        }

        // Custom detailed modal for SKU 440173 based on the screenshot
        async function showCustomDetailModal(item) {
            const modal = document.createElement('div');
            modal.className = 'detail-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '1001';
            
            // Fetch factory information from database
            let factoryInfo = {
                name: 'Loading...',
                contact_person: 'Loading...',
                phone: 'Loading...',
                email: 'Loading...',
                address: 'Loading...',
                exw_price: item.exw_cost || 15.80,
                lead_time: 'Loading...'
            };
            
            try {
                // Try to get vendor information from the MPC database using your schema
                logDebug(`Fetching vendor data for SKU: ${item.sku}`);
                
                // Strategy 1: Get vendor through vendor_price_history
                const vendorPriceQuery = `vendor_price_history?select=*,vendors(*),items!inner(*)&items.sku=eq.${item.sku}`;
                const vendorPriceData = await fetchFromDatabase(vendorPriceQuery);
                
                if (vendorPriceData && vendorPriceData.length > 0) {
                    const latestVendorPrice = vendorPriceData[0]; // Get most recent
                    const vendor = latestVendorPrice.vendors;
                    
                    if (vendor) {
                        logDebug('Found vendor through vendor_price_history', vendor);
                        factoryInfo = {
                            name: vendor.name || 'Unknown Vendor',
                            contact_person: vendor.contact_info?.contact_person || 'N/A',
                            phone: vendor.contact_info?.phone || 'N/A',
                            email: vendor.contact_info?.email || 'N/A',
                            address: `${vendor.country || 'Unknown Country'}`,
                            exw_price: latestVendorPrice.exw_cost_case || item.exw_cost || 15.80,
                            lead_time: vendor.contact_info?.lead_time_days ? `${vendor.contact_info.lead_time_days} days` : '45 days'
                        };
                    }
                } else {
                    // Strategy 2: Try direct vendor lookup if we have vendor info in rawData
                    if (item.rawData?.vendor) {
                        const vendor = item.rawData.vendor;
                        logDebug('Found vendor in rawData', vendor);
                        factoryInfo = {
                            name: vendor.name || 'Unknown Vendor',
                            contact_person: vendor.contact_info?.contact_person || 'N/A',
                            phone: vendor.contact_info?.phone || 'N/A',
                            email: vendor.contact_info?.email || 'N/A',
                            address: `${vendor.country || 'Unknown Country'}`,
                            exw_price: item.exw_cost || 15.80,
                            lead_time: vendor.contact_info?.lead_time_days ? `${vendor.contact_info.lead_time_days} days` : '45 days'
                        };
                    } else {
                        // Strategy 3: Get all vendors and try to match by item
                        const vendorsData = await fetchFromDatabase('vendors?select=*');
                        if (vendorsData && vendorsData.length > 0) {
                            // For now, use first active vendor as fallback
                            const vendor = vendorsData.find(v => v.is_active) || vendorsData[0];
                            logDebug('Using fallback vendor', vendor);
                            factoryInfo = {
                                name: vendor.name || 'Unknown Vendor',
                                contact_person: vendor.contact_info?.contact_person || 'N/A',
                                phone: vendor.contact_info?.phone || 'N/A',
                                email: vendor.contact_info?.email || 'N/A',
                                address: `${vendor.country || 'Unknown Country'}`,
                                exw_price: item.exw_cost || 15.80,
                                lead_time: vendor.contact_info?.lead_time_days ? `${vendor.contact_info.lead_time_days} days` : '45 days'
                            };
                        }
                    }
                }
            } catch (error) {
                logDebug('Failed to fetch vendor information from MPC database', error);
                // Keep default factory info if database fetch fails
                factoryInfo.name = 'Doria Sofia Manufacturing';
                factoryInfo.contact_person = 'Carlos Rodriguez';
                factoryInfo.phone = '+57-1-234-5678';
                factoryInfo.email = 'crodriguez@doriasofia.com';
                factoryInfo.address = 'Bogotá, Colombia';
                factoryInfo.lead_time = '45 days';
            }
            
            modal.innerHTML = `
                <div class="detail-content" style="max-width: 1000px; margin: 20px auto; background: white; border-radius: 20px; overflow: hidden; position: relative;">
                    <div class="detail-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 25px 30px; position: relative;">
                        <button class="close-btn" onclick="this.closest('.detail-modal').remove()" style="position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.2); border: none; color: white; font-size: 1.5rem; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease;">&times;</button>
                        <div class="item-title" style="font-size: 1.6rem; font-weight: 700; margin-bottom: 8px;">440173 - Sweet Plantain Slices</div>
                        <div class="item-subtitle" style="opacity: 0.9; font-size: 1rem; margin-bottom: 15px;">Doria Sofia | 4/36oz | 4 units per case</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: rgba(255,255,255,0.9); font-size: 0.9rem; font-weight: 500;">View pricing for:</label>
                            <select style="padding: 8px 15px; border-radius: 8px; border: none; background: rgba(255,255,255,0.95); color: #333; font-size: 0.9rem; min-width: 200px; cursor: pointer;">
                                <option>Victory Foods</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="padding: 30px;">
                        <!-- Price Flow Overview -->
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; gap: 20px; margin-bottom: 30px; align-items: center;">
                            <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 2px solid #64748b;">
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">EXW Factory Cost</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: #1e40af;">15.80</div>
                            </div>
                            <div style="font-size: 1.5rem; color: #64748b; font-weight: bold;">→</div>
                            <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 2px solid #3b82f6;">
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">FOB Price</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: #1e40af;">23.38</div>
                            </div>
                            <div style="font-size: 1.5rem; color: #64748b; font-weight: bold;">→</div>
                            <div style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); border: 2px solid #10b981;">
                                <div style="font-size: 0.85rem; color: #64748b; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">DDP Final Price</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: #1e40af;">23.89</div>
                            </div>
                        </div>

                        <!-- Container & Logistics Overview -->
                        <div style="background: linear-gradient(135deg, #f3e8ff 0%, #faf5ff 100%); border-radius: 12px; padding: 25px; margin-bottom: 30px; border: 1px solid #a855f7;">
                            <h3 style="color: #7c3aed; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">🚢 Container & Logistics Information</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; border: 1px solid #d8b4fe;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #7c3aed;">2,200</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 4px;">Cases per Container</div>
                                </div>
                                <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; border: 1px solid #d8b4fe;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #7c3aed;">52,800 lbs</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 4px;">Net Weight</div>
                                </div>
                                <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; border: 1px solid #d8b4fe;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #7c3aed;">$5,675</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 4px;">Ocean Freight Total</div>
                                </div>
                                <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; border: 1px solid #d8b4fe;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #7c3aed;">$1,122</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 4px;">Inland Freight Total</div>
                                </div>
                                <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; border: 1px solid #d8b4fe;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #7c3aed;">10×11</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 4px;">Pallet Pattern (TI×HI)</div>
                                </div>
                                <div style="background: white; border-radius: 8px; padding: 15px; text-align: center; border: 1px solid #d8b4fe;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: #7c3aed;">Palletized</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 4px;">Configuration</div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Cost Perspectives -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fef7cd 100%); border-radius: 12px; padding: 25px; border: 1px solid #f59e0b;">
                                <h3 style="color: #1e40af; margin-bottom: 20px; font-size: 1.1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; display: flex; align-items: center; gap: 8px;">📦 Vendor Costs</h3>
                                <div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">EXW Factory Cost:</span>
                                        <span style="font-weight: 600; color: #1f2937;">15.80</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">Sales Broker (3%):</span>
                                        <span style="font-weight: 600; color: #1f2937;">0.72</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">Tariff (10%):</span>
                                        <span style="font-weight: 600; color: #1f2937;">1.58</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">Import Broker:</span>
                                        <span style="font-weight: 600; color: #1f2937;">0.14</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: #059669; font-size: 1rem; margin-top: 10px; padding-top: 10px; border-top: 2px solid #10b981;">
                                        <span>Total Vendor Cost:</span>
                                        <span>18.24</span>
                                    </div>
                                </div>
                            </div>

                            <div style="background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%); border-radius: 12px; padding: 25px; border: 1px solid #3b82f6;">
                                <h3 style="color: #1e40af; margin-bottom: 20px; font-size: 1.1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; display: flex; align-items: center; gap: 8px;">🚢 Shipping & Logistics</h3>
                                <div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">Ocean Freight/Case:</span>
                                        <span style="font-weight: 600; color: #1f2937;">$2.58</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">Inland Freight/Case:</span>
                                        <span style="font-weight: 600; color: #1f2937;">$0.51</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">Case Weight:</span>
                                        <span style="font-weight: 600; color: #1f2937;">24 lbs</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">Units per Case:</span>
                                        <span style="font-weight: 600; color: #1f2937;">4 units</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: #059669; font-size: 1rem; margin-top: 10px; padding-top: 10px; border-top: 2px solid #10b981;">
                                        <span>Total Freight/Case:</span>
                                        <span>$3.09</span>
                                    </div>
                                </div>
                            </div>

                            <div style="background: linear-gradient(135deg, #d1fae5 0%, #dcfce7 100%); border-radius: 12px; padding: 25px; border: 1px solid #10b981;">
                                <h3 style="color: #1e40af; margin-bottom: 20px; font-size: 1.1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; display: flex; align-items: center; gap: 8px;">💰 SFS Margins</h3>
                                <div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">Landed Cost:</span>
                                        <span style="font-weight: 600; color: #1f2937;">20.82</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">SFS Margin (16.2%):</span>
                                        <span style="font-weight: 600; color: #1f2937;">2.56</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                        <span style="color: #4b5563;">Operating Costs:</span>
                                        <span style="font-weight: 600; color: #1f2937;">1.07</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: #059669; font-size: 1rem; margin-top: 10px; padding-top: 10px; border-top: 2px solid #10b981;">
                                        <span>Total SFS Margin:</span>
                                        <span>2.56</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Factory Information -->
                        <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-radius: 12px; padding: 25px; border: 1px solid #10b981;">
                            <h3 style="color: #059669; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">🏭 Factory Information & Contact Details</h3>
                            <div style="background: white; border-radius: 8px; padding: 20px; border: 1px solid #a7f3d0;">
                                <div style="font-weight: 700; color: #059669; font-size: 1.1rem; margin-bottom: 15px;">${factoryInfo.name}</div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                    <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                                        <span style="width: 16px; text-align: center;">👤</span>
                                        <span>${factoryInfo.contact_person}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                                        <span style="width: 16px; text-align: center;">📞</span>
                                        <span>${factoryInfo.phone}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                                        <span style="width: 16px; text-align: center;">📧</span>
                                        <span>${factoryInfo.email}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                                        <span style="width: 16px; text-align: center;">📍</span>
                                        <span>${factoryInfo.address}</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                                    <span style="color: #4b5563;">EXW Price per Case:</span>
                                    <span style="font-weight: 600; color: #1f2937;">${factoryInfo.exw_price.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 0.9rem;">
                                    <span style="color: #4b5563;">Lead Time:</span>
                                    <span style="font-weight: 600; color: #1f2937;">${factoryInfo.lead_time}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.remove();
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // Render items in table
        function renderItems(items) {
            const tableContainer = document.getElementById('itemsTable');
            const header = tableContainer.querySelector('.table-header');
            
            // Clear existing rows
            const existingRows = tableContainer.querySelectorAll('.table-row');
            existingRows.forEach(row => row.remove());

            if (items.length === 0) {
                const noResults = document.createElement('div');
                noResults.style.cssText = 'text-align: center; padding: 40px; color: #6b7280; grid-column: 1 / -1;';
                noResults.textContent = 'No items found';
                tableContainer.appendChild(noResults);
                return;
            }

            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'table-row';
                row.onclick = () => showItemDetail(item);
                
                const marginClass = getMarginClass(item.sfs_margin_rate);
                const hasRebate = item.ddp_rebate > 0;
                
                row.innerHTML = `
                    <div class="sku">${item.sku}</div>
                    <div class="description" title="${item.description}">${truncateText(item.description, 25)}</div>
                    <div class="brand">
                        <div style="font-weight: 600;">${item.brand}</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">${item.category}</div>
                    </div>
                    <div class="customer">${item.customer_code || item.customer}</div>
                    <div class="brand">${item.quarter}</div>
                    <div class="brand">${item.package}</div>
                    <div class="price">${item.exw_cost.toFixed(2)}</div>
                    <div class="price">${item.fob_price.toFixed(2)}</div>
                    <div class="price">${item.ddp_price.toFixed(2)}</div>
                    <div class="price ${hasRebate ? 'margin-good' : ''}">
                        ${item.ddp_net_price.toFixed(2)}
                        ${hasRebate ? '<div style="font-size: 0.7rem;">rebate</div>' : ''}
                    </div>
                    <div class="margin ${marginClass}">${item.sfs_margin_rate.toFixed(1)}%</div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="event.stopPropagation(); showPriceHistory('${item.sku}')" 
                                style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem;">
                            📈
                        </button>
                        <button onclick="event.stopPropagation(); showVendorInfo('${item.sku}')" 
                                style="background: #059669; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem;">
                            🏭
                        </button>
                    </div>
                `;
                
                tableContainer.appendChild(row);
            });
        }

        // Price history modal (moved analytics dashboard content here)
        function showPriceHistory(sku) {
            const modal = document.createElement('div');
            modal.className = 'detail-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '1001';
            
            modal.innerHTML = `
                <div class="detail-content" style="max-width: 1800px; max-height: 90vh; overflow-y: auto;">
                    <div class="detail-header" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
                        <button class="close-btn" onclick="this.closest('.detail-modal').remove()">&times;</button>
                        <div class="item-title">📊 SFS Analytics Dashboard</div>
                        <div class="item-subtitle">Victory Foods - Sweet Plantain Slices Analysis (Real Data)</div>
                    </div>
                    
                    <div class="detail-body" style="padding: 30px;">
					<div style="font-size: 1.3rem; font-weight: 400; color: #1f2937; margin-bottom: 8px;">440173 - Sweet Plantain Slices</div>
                           
                        <!-- Real Executive Metrics -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 4px solid #10b981;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div style="font-size: 0.85rem; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Container Value</div>
                                    <div style="font-size: 0.8rem; padding: 2px 8px; border-radius: 12px; font-weight: 600; background: #f3f4f6; color: #6b7280;">2,200 cases</div>
                                </div>
                                <div style="font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 8px;">$3.23</div>
                                <div style="font-size: 0.85rem; color: #6b7280;">Total logistics cost allocation</div>
                            </div>

                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 4px solid #3b82f6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div style="font-size: 0.85rem; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">SFS Gross Margin</div>
                                    <div style="font-size: 0.8rem; padding: 2px 8px; border-radius: 12px; font-weight: 600; background: #f3f4f6; color: #6b7280;">Per Case</div>
                                </div>
                                <div style="font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 8px;">14.5%</div>
                                <div style="font-size: 0.85rem; color: #6b7280;">$2.29 gross profit per case</div>
                            </div>

                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 4px solid #f59e0b;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div style="font-size: 0.85rem; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Competitive Advantage</div>
                                    <div style="font-size: 0.8rem; padding: 2px 8px; border-radius: 12px; font-weight: 600; background: #d1fae5; color: #059669;">vs Sabor Nuestro</div>
                                </div>
                                <div style="font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 8px;">$7.73</div>
                                <div style="font-size: 0.85rem; color: #6b7280;">Lower price per case (24.5%)</div>
                            </div>

                            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 4px solid #8b5cf6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <div style="font-size: 0.85rem; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Container Total Value</div>
                                    <div style="font-size: 0.8rem; padding: 2px 8px; border-radius: 12px; font-weight: 600; background: #f3f4f6; color: #6b7280;">Full Container</div>
                                </div>
                                <div style="font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 8px;">$52,556</div>
                                <div style="font-size: 0.85rem; color: #6b7280;">Total container value at DDP price</div>
                            </div>				
                        </div>

                        <!-- Cost Breakdown & Competition -->
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-bottom: 30px;">
                            <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                                <div style="font-size: 1.1rem; font-weight: 700; color: #1f2937; margin-bottom: 20px;">💰 Actual Cost Breakdown - SKU 440173</div>
                                <div style="height: 250px; background: white; border-radius: 8px; padding: 20px; position: relative; overflow: hidden;">
                                    <div style="position: absolute; left: 2%; top: 60%; width: 11%; height: 35%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 4px; color: white; font-size: 0.75rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div>EXW Cost</div>
                                        <div>$15.80</div>
                                    </div>
                                    <div style="position: absolute; left: 15%; top: 55%; width: 9%; height: 40%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 4px; color: white; font-size: 0.75rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div>Tariff</div>
                                        <div>$1.58</div>
                                    </div>
                                    <div style="position: absolute; left: 26%; top: 52%; width: 9%; height: 43%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 4px; color: white; font-size: 0.75rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div>Sales Broker</div>
                                        <div>$0.72</div>
                                    </div>
                                    <div style="position: absolute; left: 37%; top: 50%; width: 8%; height: 45%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 4px; color: white; font-size: 0.75rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div>Import</div>
                                        <div>$0.14</div>
                                    </div>
                                    <div style="position: absolute; left: 47%; top: 35%; width: 11%; height: 60%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 4px; color: white; font-size: 0.75rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div>Ocean Freight</div>
                                        <div>$2.58</div>
                                    </div>
                                    <div style="position: absolute; left: 60%; top: 32%; width: 9%; height: 63%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 4px; color: white; font-size: 0.75rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div>Inland</div>
                                        <div>$0.51</div>
                                    </div>
                                    <div style="position: absolute; left: 71%; top: 18%; width: 11%; height: 77%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 4px; color: white; font-size: 0.75rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div>SFS Margin</div>
                                        <div>$2.29</div>
                                    </div>
                                    <div style="position: absolute; left: 84%; top: 5%; width: 14%; height: 90%; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 4px; color: white; font-size: 0.75rem; font-weight: 600; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div>DDP Price</div>
                                        <div>$23.89</div>
                                    </div>
                                </div>
                            </div>

                            <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                                <div style="font-size: 1.1rem; font-weight: 700; color: #1f2937; margin-bottom: 20px;">🎯 Current Market Position</div>
                                <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                                    <thead>
                                        <tr>
                                            <th style="background: #f8fafc; padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; font-size: 0.85rem;">Supplier</th>
                                            <th style="background: #f8fafc; padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; font-size: 0.85rem;">Price/Case</th>
                                            <th style="background: #f8fafc; padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; font-size: 0.85rem;">Difference</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="background: #f0f9ff; font-weight: 700;">
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem;"><strong>SFS (You)</strong></td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem;"><strong>$23.89</strong></td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; color: #059669; font-weight: 600;">Baseline</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem;">Sabor Nuestro 4/5lb</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem;">$31.62</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; color: #059669; font-weight: 600;">+$7.73 (+32%)</td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem;">Sabor Nuestro 6/5lb</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem;">$34.60</td>
                                            <td style="padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 0.9rem; color: #059669; font-weight: 600;">+$10.71 (+45%)</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 8px; font-size: 0.85rem;">
                                    <strong>Market Position:</strong> Your pricing provides significant value to Victory Foods with 24-45% cost savings vs alternatives.
                                </div>
                            </div>
                        </div>

                        <!-- Historical Pricing Analysis -->
                        <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 30px;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: #1f2937; margin-bottom: 20px;">📈 Historical Pricing Analysis (From Your Research)</div>
                            
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; margin-bottom: 12px; padding: 12px; border-radius: 8px; background: #f8fafc; font-weight: 600;">
                                <div>Supplier</div>
                                <div style="text-align: center; padding: 15px; border-radius: 8px; margin: 0 5px; font-weight: 600; background: #dbeafe; color: #1d4ed8;">2025</div>
                                <div style="text-align: center; padding: 15px; border-radius: 8px; margin: 0 5px; font-weight: 600; background: #fef3c7; color: #d97706;">2024</div>
                                <div style="text-align: center; padding: 15px; border-radius: 8px; margin: 0 5px; font-weight: 600; background: #f3e8ff; color: #7c3aed;">2023</div>
                                <div style="text-align: center; padding: 15px; border-radius: 8px; margin: 0 5px; font-weight: 600; background: #ecfdf5; color: #059669;">2022</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; margin-bottom: 12px; padding: 12px; border-radius: 8px; transition: background 0.2s ease;">
                                <div style="font-weight: 600; color: #1f2937;">SFS (Your Pricing)</div>
                                <div style="text-align: center; font-weight: 600; color: #374151;">$23.09</div>
                                <div style="text-align: center; font-weight: 600; color: #374151;">NE</div>
                                <div style="text-align: center; font-weight: 600; color: #374151;">NE</div>
                                <div style="text-align: center; font-weight: 600; color: #374151;">NE</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 15px; align-items: center; margin-bottom: 12px; padding: 12px; border-radius: 8px; transition: background 0.2s ease;">
                                <div style="font-weight: 600; color: #1f2937;">Sabor Nuestro Sweet Plantain</div>
                                <div style="text-align: center; font-weight: 600; color: #374151;">$31.62</div>
                                <div style="text-align: center; font-weight: 600; color: #374151;">$22.73 - $23.00</div>
                                <div style="text-align: center; font-weight: 600; color: #374151;">$26.72 - $29.31</div>
                                <div style="text-align: center; font-weight: 600; color: #374151;">$22.03 - $22.23</div>
                            </div>
                            
                            <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                    <div style="font-weight: 600; color: #1d4ed8; margin-bottom: 8px;">Supplier Cost History</div>
                                    <div style="font-size: 0.9rem; color: #374151;">
                                        <strong>2025:</strong> $15.60 → Current $15.80<br>
                                        <strong>2024:</strong> $21.25 - $21.50<br>
                                        <strong>2023:</strong> $15.60 - $21.50
                                    </div>
                                </div>
                                <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                                    <div style="font-weight: 600; color: #059669; margin-bottom: 8px;">Key Insights</div>
                                    <div style="font-size: 0.9rem; color: #374151;">
                                        • Competitor prices more volatile<br>
                                        • Your costs remained stable<br>
                                        • Maintained 24%+ price advantage
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Source Attribution -->
                        <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 15px; font-size: 0.85rem; color: #1e40af;">
                            <strong>📋 Data Sources:</strong> All metrics derived from Victory Foods Info Sheet (4/8/25), competitor pricing research section, and historical supplier cost tracking. No external estimates or projections used.
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Vendor info modal
        function showVendorInfo(sku) {
            alert('🏭 Vendor Information - ' + sku + '\n\nThis would display:\n• Complete vendor contact details\n• Supply chain performance metrics\n• Quality and delivery ratings\n• Alternative supplier options\n• Risk assessment data\n\nData from vendors and vendor_price_history tables would provide comprehensive supplier insights.');
        }

        // Update detail sections with Victory Foods data
        function updateDetailSections(data) {
            // Update container stats
            document.getElementById('containerCases').textContent = '2,200';
            document.getElementById('containerWeight').textContent = '52,800 lbs';
            document.getElementById('oceanFreightTotal').textContent = '$5,675';
            document.getElementById('inlandFreightTotal').textContent = '$1,122';
            document.getElementById('palletPattern').textContent = '10×11';
            document.getElementById('configuration').textContent = 'Palletized';
            
            // Update vendor costs
            const vendorContainer = document.getElementById('vendorCosts');
            vendorContainer.innerHTML = `
                <div class="cost-line">
                    <span class="cost-label">EXW Factory Cost:</span>
                    <span class="cost-value">${(data.exw_cost_case || 15.80).toFixed(2)}</span>
                </div>
                <div class="cost-line">
                    <span class="cost-label">Sales Broker (${(data.sales_broker_rate_percent || 3).toFixed(1)}%):</span>
                    <span class="cost-value">${(data.sales_broker_amount_case || 0.72).toFixed(2)}</span>
                </div>
                <div class="cost-line">
                    <span class="cost-label">Tariff (${(data.tariff_rate_percent || 10).toFixed(1)}%):</span>
                    <span class="cost-value">${(data.tariff_amount_case || 1.58).toFixed(2)}</span>
                </div>
                <div class="cost-line">
                    <span class="cost-label">Import Broker:</span>
                    <span class="cost-value">${(data.import_broker_per_case || 0.14).toFixed(2)}</span>
                </div>
                <div class="cost-line total">
                    <span class="cost-label">Total Vendor Cost:</span>
                    <span class="cost-value">${((data.exw_cost_case || 15.80) + (data.sales_broker_amount_case || 0.72) + (data.tariff_amount_case || 1.58) + (data.import_broker_per_case || 0.14)).toFixed(2)}</span>
                </div>
            `;
            
            // Update shipping costs
            const shippingContainer = document.getElementById('shippingCosts');
            shippingContainer.innerHTML = `
                <div class="cost-line">
                    <span class="cost-label">Ocean Freight/Case:</span>
                    <span class="cost-value">$2.58</span>
                </div>
                <div class="cost-line">
                    <span class="cost-label">Inland Freight/Case:</span>
                    <span class="cost-value">$0.51</span>
                </div>
                <div class="cost-line">
                    <span class="cost-label">Case Weight:</span>
                    <span class="cost-value">24 lbs</span>
                </div>
                <div class="cost-line">
                    <span class="cost-label">Units per Case:</span>
                    <span class="cost-value">4 units</span>
                </div>
                <div class="cost-line total">
                    <span class="cost-label">Total Freight/Case:</span>
                    <span class="cost-value">$3.09</span>
                </div>
            `;
            
            // Update SFS margins
            const marginsContainer = document.getElementById('sfsMargins');
            const landedCost = (data.fob_price_case || 23.38) - (data.sfs_margin_amount_case || 2.56);
            marginsContainer.innerHTML = `
                <div class="cost-line">
                    <span class="cost-label">Landed Cost:</span>
                    <span class="cost-value">${landedCost.toFixed(2)}</span>
                </div>
                <div class="cost-line">
                    <span class="cost-label">SFS Margin (${(data.sfs_margin_rate_percent || 16.2).toFixed(1)}%):</span>
                    <span class="cost-value">${(data.sfs_margin_amount_case || 2.56).toFixed(2)}</span>
                </div>
                <div class="cost-line">
                    <span class="cost-label">Operating Costs:</span>
                    <span class="cost-value">$1.07</span>
                </div>
                <div class="cost-line total">
                    <span class="cost-label">Total SFS Margin:</span>
                    <span class="cost-value">${(data.sfs_margin_amount_case || 2.56).toFixed(2)}</span>
                </div>
            `;
            
            // Update customer details
            const customerContainer = document.getElementById('customerDetails');
            const customerInfo = data.customers || {};
            const contactInfo = customerInfo.contact_info || {};
            
            customerContainer.innerHTML = `
                <div class="customer-name">${customerInfo.name || 'Victory Foods'}</div>
                <div class="contact-grid">
                    <div class="contact-item">
                        <span class="contact-icon">👤</span>
                        <span>${contactInfo.contact_person || 'Alan Bernstein'}</span>
                    </div>
                    <div class="contact-item">
                        <span class="contact-icon">📞</span>
                        <span>${contactInfo.phone || '718-378-1122'}</span>
                    </div>
                    <div class="contact-item">
                        <span class="contact-icon">📧</span>
                        <span>${contactInfo.email || 'abernstein@victoryfoodservice.com'}</span>
                    </div>
                    <div class="contact-item">
                        <span class="contact-icon">📍</span>
                        <span>${contactInfo.address || '515 Truxton St. Bronx, NY 10474'}</span>
                    </div>
                </div>
                <div class="cost-line">
                    <span class="cost-label">Rebate per Case:</span>
                    <span class="cost-value">${(data.ddp_rebate_case || 22.88).toFixed(2)}</span>
                </div>
                <div class="cost-line">
                    <span class="cost-label">Net Price per Case:</span>
                    <span class="cost-value">${(data.ddp_net_price_case || 1.01).toFixed(2)}</span>
                </div>
            `;
        }

        // Utility functions
        function truncateText(text, maxLength) {
            return text && text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function getMarginClass(margin) {
            if (margin >= 18) return 'margin-good';
            if (margin >= 15) return 'margin-warning';
            return 'margin-danger';
        }

        function hideLoading() {
            const loadingState = document.getElementById('loadingState');
            if (loadingState) {
                loadingState.style.display = 'none';
            }
        }

        // Close detail modal
        function closeDetail() {
            document.getElementById('detailModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Retry connection
        async function retryConnection() {
            updateConnectionStatus('Retrying connection...', 'warning');
            currentItems = [];
            allItemsData = [];
            debugLog = [];
            
            document.getElementById('loadingState').style.display = 'block';
            await initializeApp();
        }

        // Load sample data
        function loadSampleData() {
            logDebug('User requested sample data');
            currentItems = createSampleData();
            allItemsData = currentItems;
            hideLoading();
            renderItems(currentItems);
        }

        // Enhanced search
        function enhancedSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredItems = currentItems.filter(item =>
                item.sku.toLowerCase().includes(searchTerm) ||
                item.description.toLowerCase().includes(searchTerm) ||
                item.brand.toLowerCase().includes(searchTerm) ||
                item.customer.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
            );
            renderItems(filteredItems);
        }

        // Initialize app with enhanced database analysis
        async function initializeApp() {
            try {
                logDebug('Starting enhanced app initialization...');
                updateConnectionStatus('🔍 Connecting to MPC database and analyzing structure...', 'warning');
                
                // Clear any existing content that might be interfering
                document.body.style.overflow = 'auto';
                
                // Test basic connectivity first
                const isConnected = await testBasicConnectivity();
                if (!isConnected) {
                    logDebug('Basic connectivity failed, using sample data');
                    currentItems = createSampleData();
                } else {
                    // Try to load real data with comprehensive analysis
                    currentItems = await loadRealDatabaseItems();
                }
                
                allItemsData = currentItems;
                
                // Setup search
                document.getElementById('searchInput').addEventListener('input', enhancedSearch);
                
                // Render items
                hideLoading();
                renderItems(currentItems);
                
                logDebug('Enhanced app initialization completed successfully');
                
                // Add a button to re-analyze database
                addDatabaseAnalysisButton();
                
            } catch (error) {
                logDebug('App initialization failed completely', error);
                updateConnectionStatus('❌ Initialization failed. Using sample data.', 'error');
                currentItems = createSampleData();
                allItemsData = currentItems;
                hideLoading();
                renderItems(currentItems);
            }
        }

        // Add database analysis button for debugging
        function addDatabaseAnalysisButton() {
            const controlsContainer = document.querySelector('.controls');
            if (controlsContainer && !document.getElementById('analyzeDbBtn')) {
                const analyzeBtn = document.createElement('button');
                analyzeBtn.id = 'analyzeDbBtn';
                analyzeBtn.className = 'retry-button';
                analyzeBtn.style.cssText = 'background: #8b5cf6; margin-left: 10px;';
                analyzeBtn.innerHTML = '🔍 Analyze Database';
                analyzeBtn.onclick = async () => {
                    toggleDebug(); // Show debug info
                    await analyzeDatabaseStructure();
                };
                controlsContainer.appendChild(analyzeBtn);
            }
        }

        // Close modal when clicking outside
        document.getElementById('detailModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeDetail();
            }
        });

        // Start the app
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
