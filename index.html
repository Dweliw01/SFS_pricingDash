<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFS Price Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            padding: 30px;
        }

        .connection-status {
            padding: 15px 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #34d399;
        }

        .connection-status.disconnected {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #f87171;
        }

        .connection-status.testing {
            background: linear-gradient(135deg, #dbeafe 0%, #93c5fd 100%);
            color: #1e40af;
            border: 1px solid #60a5fa;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .quarter-selector {
            position: relative;
        }

        .quarter-selector select {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 40px 12px 20px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            appearance: none;
            min-width: 150px;
        }

        .quarter-selector::after {
            content: '‚ñº';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            pointer-events: none;
        }

        .search-container {
            flex: 1;
            position: relative;
            max-width: 500px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 1.2rem;
        }

        .items-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .table-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            display: grid;
            grid-template-columns: 120px 1fr 150px 120px 100px;
            gap: 20px;
            font-weight: 600;
            color: #334155;
        }

        .table-row {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: grid;
            grid-template-columns: 120px 1fr 150px 120px 100px;
            gap: 20px;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .table-row:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .sku {
            font-weight: 600;
            color: #1e40af;
        }

        .description {
            color: #334155;
        }

        .brand {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .price {
            font-weight: 700;
            color: #059669;
            font-size: 1.1rem;
        }

        .customer {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .error {
            background: #fef2f2;
            color: #991b1b;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #fecaca;
        }

        .detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .detail-content {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
        }

        .detail-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .item-info {
            margin-bottom: 20px;
        }

        .item-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .item-subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }

        .detail-body {
            padding: 30px;
        }

        .perspectives {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .perspective {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .perspective h3 {
            color: #1e40af;
            margin-bottom: 20px;
            font-size: 1.2rem;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .cost-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .cost-line:last-child {
            border-bottom: none;
            font-weight: 700;
            color: #059669;
            font-size: 1.1rem;
        }

        .cost-line.total {
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #1e40af;
        }

        .cost-label {
            color: #6b7280;
        }

        .cost-value {
            font-weight: 600;
            color: #1f2937;
        }

        .profit-analysis {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .profit-analysis h3 {
            color: #059669;
            margin-bottom: 15px;
        }

        .profit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .perspectives {
                grid-template-columns: 1fr;
            }
            
            .table-header,
            .table-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† SFS Price Viewer</h1>
            <p>Comprehensive pricing portal with vendor costs, shipping breakdowns, and customer pricing</p>
        </div>

        <div class="main-content">
            <!-- Connection Status -->
            <div class="connection-status testing" id="connectionStatus">
                <span id="statusIcon">üîÑ</span>
                <span id="statusText">Connecting to database...</span>
            </div>

            <div class="controls">
                <div class="quarter-selector">
                    <select id="quarterSelect">
                        <option>Loading quarters...</option>
                    </select>
                </div>
                
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search items, SKU, or brand...">
                    <div class="search-icon">üîç</div>
                </div>
            </div>

            <div class="items-table" id="itemsTable">
                <div class="table-header">
                    <div>SKU</div>
                    <div>Description</div>
                    <div>Brand</div>
                    <div>DDP Price</div>
                    <div>Customer</div>
                </div>
                
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                    <div>Connecting to database...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="detail-modal" id="detailModal">
        <div class="detail-content">
            <div class="detail-header">
                <button class="close-btn" onclick="closeDetail()">&times;</button>
                <div class="item-info">
                    <div class="item-title" id="detailItemTitle">Loading...</div>
                    <div class="item-subtitle" id="detailItemSubtitle">Package info loading...</div>
                </div>
            </div>
            
            <div class="detail-body" id="detailBody">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading detailed pricing information...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // üîß SUPABASE CONFIGURATION
        // ==========================================
        
        const SUPABASE_CONFIG = {
            url: 'https://uiuqbnzxtcppyqgyaqoi.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVpdXFibnp4dGNwcHlxZ3lhcW9pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5NTY1OTUsImV4cCI6MjA2NTUzMjU5NX0.TIElW0BH01THuaZ7AStR7rfZPLObxyo5utHvMi_DFnw',
            restUrl: 'https://uiuqbnzxtcppyqgyaqoi.supabase.co/rest/v1'
        };

        // ==========================================
        // üóÉÔ∏è SUPABASE REST CLIENT
        // ==========================================
        
        class SupabaseRestClient {
            constructor(config) {
                this.baseUrl = config.restUrl;
                this.apiKey = config.anonKey;
                this.headers = {
                    'apikey': this.apiKey,
                    'Authorization': `Bearer ${this.apiKey}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                };
            }

            async query(table, options = {}) {
                try {
                    const url = new URL(`${this.baseUrl}/${table}`);
                    
                    // Add apikey to URL params (this is what works!)
                    url.searchParams.set('apikey', this.apiKey);
                    
                    // Add query parameters
                    if (options.select) {
                        url.searchParams.set('select', options.select);
                    }
                    
                    if (options.eq) {
                        Object.entries(options.eq).forEach(([key, value]) => {
                            url.searchParams.set(key, `eq.${value}`);
                        });
                    }
                    
                    if (options.or) {
                        url.searchParams.set('or', options.or);
                    }
                    
                    if (options.order) {
                        url.searchParams.set('order', options.order);
                    }
                    
                    if (options.limit) {
                        url.searchParams.set('limit', options.limit);
                    }

                    console.log(`üåê Querying ${table}`);

                    const response = await fetch(url.toString(), {
                        method: 'GET',
                        headers: {
                            'apikey': this.apiKey,
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }

                    const data = await response.json();
                    console.log(`‚úÖ ${table} query successful:`, data.length || 1, 'records');
                    
                    return { data, error: null };
                    
                } catch (error) {
                    console.error(`‚ùå ${table} query failed:`, error.message);
                    return { data: null, error: error.message };
                }
            }

            async testConnection() {
                console.log('üîç Testing Supabase connection...');
                return await this.query('price_quarters', { 
                    select: 'id,quarter_name', 
                    limit: '1' 
                });
            }
        }

        // ==========================================
        // üóÉÔ∏è DATABASE QUERY FUNCTIONS
        // ==========================================
        
        class PricingService {
            constructor(client) {
                this.client = client;
            }

            async getPriceQuarters() {
                console.log('üìÖ Loading price quarters...');
                return await this.client.query('price_quarters', {
                    select: 'id,quarter_name,fiscal_year,fiscal_qtr,is_current,start_date',
                    order: 'start_date.desc'
                });
            }

            async getCurrentQuarter() {
                const result = await this.client.query('price_quarters', {
                    select: 'id,quarter_name',
                    eq: { is_current: true },
                    limit: '1'
                });
                
                if (result.data && result.data.length > 0) {
                    return result.data[0];
                }
                
                // Fallback to latest quarter
                const latestResult = await this.client.query('price_quarters', {
                    select: 'id,quarter_name',
                    order: 'start_date.desc',
                    limit: '1'
                });
                
                return latestResult.data?.[0] || null;
            }

            async getItemsWithPricing(quarterId, searchTerm = '') {
                console.log('üì¶ Loading items with pricing...', { quarterId, searchTerm });
                
                let options = {
                    select: `
                        id,
                        item_id,
                        customer_id,
                        quarter_id,
                        ddp_cost_case_net,
                        ddp_cost_case,
                        ddp_cost_unit_net,
                        ddp_cost_unit,
                        items!inner(
                            id,
                            sku,
                            description,
                            brand,
                            units_per_case,
                            weight_per_unit,
                            package_size,
                            is_active
                        ),
                        customers(
                            name,
                            code
                        )
                    `,
                    eq: {
                        'items.is_active': true
                    },
                    order: 'items.sku.asc'
                };

                if (quarterId) {
                    options.eq.quarter_id = quarterId;
                }

                if (searchTerm) {
                    const pattern = `%${searchTerm}%`;
                    options.or = `items.sku.ilike.${pattern},items.description.ilike.${pattern},items.brand.ilike.${pattern}`;
                }

                return await this.client.query('customer_price_history', options);
            }

            async getItemDetailedPricing(itemId, quarterId) {
                console.log('üîç Loading detailed pricing...', { itemId, quarterId });
                
                // Get customer pricing data
                const customerResult = await this.client.query('customer_price_history', {
                    select: `
                        *,
                        items(
                            sku,
                            description,
                            brand,
                            units_per_case,
                            weight_per_unit,
                            package_size
                        ),
                        customers(
                            name,
                            code
                        )
                    `,
                    eq: {
                        item_id: itemId,
                        quarter_id: quarterId
                    },
                    limit: '1'
                });

                // Get vendor pricing data
                const vendorResult = await this.client.query('vendor_price_history', {
                    select: `
                        *,
                        vendors(
                            name,
                            code,
                            country
                        )
                    `,
                    eq: {
                        item_id: itemId,
                        quarter_id: quarterId
                    },
                    limit: '1'
                });

                return {
                    customer: customerResult.data?.[0] || null,
                    vendor: vendorResult.data?.[0] || null
                };
            }

            async getItemPriceHistory(itemId, limit = 8) {
                return await this.client.query('customer_price_history', {
                    select: `
                        ddp_cost_case_net,
                        ddp_cost_case,
                        quarter_id,
                        price_quarters!inner(
                            quarter_name,
                            start_date
                        )
                    `,
                    eq: { item_id: itemId },
                    order: 'price_quarters.start_date.desc',
                    limit: limit.toString()
                });
            }
        }

        // ==========================================
        // üé® PRICING PORTAL APPLICATION
        // ==========================================
        
        class PricingPortal {
            constructor() {
                this.client = new SupabaseRestClient(SUPABASE_CONFIG);
                this.service = new PricingService(this.client);
                this.currentQuarter = null;
                this.quarters = [];
                this.items = [];
                this.searchTerm = '';
                this.searchTimeout = null;
            }

            async initialize() {
                console.log('üöÄ Initializing SFS Pricing Portal...');
                
                this.updateConnectionStatus('testing', 'üîÑ', 'Testing database connection...');
                
                try {
                    // Test connection with a more reliable method
                    console.log('Testing connection...');
                    const testUrl = `${SUPABASE_CONFIG.restUrl}/price_quarters?select=id&limit=1&apikey=${SUPABASE_CONFIG.anonKey}`;
                    
                    const testResponse = await fetch(testUrl, {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_CONFIG.anonKey,
                            'Authorization': `Bearer ${SUPABASE_CONFIG.anonKey}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!testResponse.ok) {
                        throw new Error(`HTTP ${testResponse.status}: ${await testResponse.text()}`);
                    }
                    
                    const testData = await testResponse.json();
                    console.log('‚úÖ Connection successful:', testData);

                    this.updateConnectionStatus('connected', '‚úÖ', 'Connected to Supabase database');
                    
                    // Load quarters and items
                    await this.loadQuarters();
                    await this.loadItems();
                    
                    this.setupEventListeners();
                    
                } catch (error) {
                    console.error('‚ùå Initialization failed:', error);
                    this.updateConnectionStatus('disconnected', '‚ùå', `Connection failed: ${error.message}`);
                    this.showError('Failed to connect to database. Please check your connection and try again.');
                }
            }

            updateConnectionStatus(status, icon, text) {
                const statusEl = document.getElementById('connectionStatus');
                const iconEl = document.getElementById('statusIcon');
                const textEl = document.getElementById('statusText');
                
                statusEl.className = `connection-status ${status}`;
                iconEl.textContent = icon;
                textEl.textContent = text;
            }

            async loadQuarters() {
                try {
                    const result = await this.service.getPriceQuarters();
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }

                    this.quarters = result.data || [];
                    this.populateQuarterSelect();
                    
                    // Set current quarter
                    const currentQuarter = await this.service.getCurrentQuarter();
                    this.currentQuarter = currentQuarter?.id || null;
                    
                    if (this.currentQuarter) {
                        document.getElementById('quarterSelect').value = this.currentQuarter;
                    }
                    
                    console.log('‚úÖ Loaded quarters:', this.quarters.length);
                    
                } catch (error) {
                    console.error('‚ùå Failed to load quarters:', error);
                    this.showError('Failed to load quarters: ' + error.message);
                }
            }

            populateQuarterSelect() {
                const select = document.getElementById('quarterSelect');
                select.innerHTML = '';
                
                if (this.quarters.length === 0) {
                    select.innerHTML = '<option>No quarters available</option>';
                    return;
                }
                
                this.quarters.forEach(quarter => {
                    const option = document.createElement('option');
                    option.value = quarter.id;
                    option.textContent = quarter.quarter_name;
                    if (quarter.is_current) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }

            async loadItems() {
                try {
                    this.showLoading('Loading pricing data...');
                    
                    const result = await this.service.getItemsWithPricing(this.currentQuarter, this.searchTerm);
                    
                    if (result.error) {
                        throw new Error(result.error);
                    }

                    this.items = result.data || [];
                    this.renderItems();
                    
                    console.log('‚úÖ Loaded items:', this.items.length);
                    
                } catch (error) {
                    console.error('‚ùå Failed to load items:', error);
                    this.showError('Failed to load items: ' + error.message);
                }
            }

            showLoading(message) {
                const loadingEl = document.getElementById('loadingState');
                loadingEl.style.display = 'block';
                loadingEl.innerHTML = `
                    <div class="spinner"></div>
                    <div>${message}</div>
                `;
            }

            hideLoading() {
                document.getElementById('loadingState').style.display = 'none';
            }

            showError(message) {
                this.hideLoading();
                const tableContainer = document.getElementById('itemsTable');
                
                // Remove existing errors
                const existingErrors = tableContainer.querySelectorAll('.error');
                existingErrors.forEach(error => error.remove());
                
                const errorEl = document.createElement('div');
                errorEl.className = 'error';
                errorEl.innerHTML = `
                    <strong>Error:</strong> ${message}
                    <br><br>
                    <strong>Troubleshooting:</strong>
                    <ul style="margin-top: 10px; margin-left: 20px;">
                        <li>Verify your Supabase project is active</li>
                        <li>Check Row Level Security policies</li>
                        <li>Ensure your database contains data</li>
                    </ul>
                `;
                tableContainer.appendChild(errorEl);
            }

            renderItems() {
                this.hideLoading();
                const tableContainer = document.getElementById('itemsTable');
                
                // Clear existing content except header
                const header = tableContainer.querySelector('.table-header');
                tableContainer.innerHTML = '';
                tableContainer.appendChild(header);
                
                if (this.items.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'loading';
                    noResults.innerHTML = '<div>No items found for the selected criteria</div>';
                    tableContainer.appendChild(noResults);
                    return;
                }
                
                this.items.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'table-row';
                    row.onclick = () => this.showItemDetail(item);
                    
                    const ddpPrice = item.ddp_cost_case_net || item.ddp_cost_case || 0;
                    const customerName = item.customers?.name || 'N/A';
                    
                    row.innerHTML = `
                        <div class="sku">${item.items.sku || 'N/A'}</div>
                        <div class="description">${item.items.description || 'N/A'}</div>
                        <div class="brand">${item.items.brand || 'N/A'}</div>
                        <div class="price">$${ddpPrice.toFixed(2)}</div>
                        <div class="customer">${customerName}</div>
                    `;
                    
                    tableContainer.appendChild(row);
                });
                
                // Add pagination info
                const pagination = document.createElement('div');
                pagination.style.textAlign = 'center';
                pagination.style.padding = '20px';
                pagination.style.color = '#6b7280';
                pagination.innerHTML = `Showing ${this.items.length} items`;
                tableContainer.appendChild(pagination);
            }

            async showItemDetail(item) {
                const modal = document.getElementById('detailModal');
                const title = document.getElementById('detailItemTitle');
                const subtitle = document.getElementById('detailItemSubtitle');
                const body = document.getElementById('detailBody');
                
                // Show modal with loading state
                title.textContent = `${item.items.sku} - ${item.items.description || 'N/A'}`;
                subtitle.textContent = this.getPackageInfo(item.items);
                
                body.innerHTML = '<div class="loading"><div class="spinner"></div><div>Loading detailed pricing information...</div></div>';
                
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                try {
                    const detailedData = await this.service.getItemDetailedPricing(
                        item.items.id, 
                        this.currentQuarter
                    );
                    
                    const priceHistory = await this.service.getItemPriceHistory(item.items.id);
                    
                    this.renderItemDetail(detailedData, priceHistory.data || []);
                } catch (error) {
                    console.error('‚ùå Failed to load item detail:', error);
                    body.innerHTML = '<div class="error">Failed to load item details.</div>';
                }
            }

            renderItemDetail(data, history) {
                const body = document.getElementById('detailBody');
                let html = '';

                if (data.customer) {
                    const c = data.customer;
                    const price = c.ddp_cost_case_net || c.ddp_cost_case || 0;
                    html += `
                        <h3>Customer Pricing</h3>
                        <p>DDP Net: $${price.toFixed(2)} per case</p>
                    `;
                }

                if (data.vendor) {
                    const v = data.vendor;
                    html += `
                        <h3>Vendor Info</h3>
                        <p>Vendor: ${v.vendors?.name || 'N/A'}</p>
                        <p>FOB Case: $${(v.fob_cost_case || 0).toFixed(2)}</p>
                    `;
                }

                if (history.length > 0) {
                    html += '<h3>Price History</h3><ul>';
                    history.forEach(h => {
                        const price = h.ddp_cost_case_net || h.ddp_cost_case || 0;
                        html += `<li>${h.price_quarters.quarter_name}: $${price.toFixed(2)}</li>`;
                    });
                    html += '</ul>';
                }

                body.innerHTML = html || '<div>No details available.</div>';
            }

            getPackageInfo(item) {
                const units = item.units_per_case ?? 'N/A';
                const weight = item.weight_per_unit ?? 'N/A';
                const size = item.package_size ? ` (${item.package_size})` : '';
                return `${units} units/case, ${weight} ${item.unit_of_measure || ''} per unit${size}`;
            }

            setupEventListeners() {
                document.getElementById('quarterSelect').addEventListener('change', async (e) => {
                    this.currentQuarter = e.target.value;
                    await this.loadItems();
                });

                document.getElementById('searchInput').addEventListener('input', (e) => {
                    clearTimeout(this.searchTimeout);
                    this.searchTerm = e.target.value.trim();
                    this.searchTimeout = setTimeout(() => this.loadItems(), 300);
                });
            }
        }

        function closeDetail() {
            document.getElementById('detailModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        const portal = new PricingPortal();
        window.addEventListener('DOMContentLoaded', () => portal.initialize());
    </script>
</body>
</html>
